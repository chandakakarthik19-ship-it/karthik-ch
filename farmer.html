<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Farmer Dashboard - Ramana Tractor</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }

    h1, h3 {
      color: #333;
      margin: 10px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #4CAF50;
      color: white;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    .totals {
      margin-top: 15px;
      font-weight: bold;
    }

    button {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    button:hover {
      background-color: #45a049;
    }

    a {
      color: #4CAF50;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .card {
      padding: 20px;
    }
  </style>
</head>
<body>
  <main class="container" role="main">
    <h1>Farmer Dashboard</h1>
    <section class="card" aria-label="Farmer work history">

      <!-- Farmer Info -->
      <div id="pdfContent">
        <div id="info" aria-live="polite">Loading farmer info...</div>

        <h3>Work History</h3>
        <div id="historyContainer">
          <table id="historyTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Work Type</th>
                <th>Minutes</th>
                <th>Rate / 60</th>
                <th>Total Amount</th>
                <th>Paid</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="totals" id="totals"></div>
      </div>

      <button onclick="downloadPDF()">Download Work History PDF</button>
      <p><a href="#" onclick="logout()">Logout</a></p>
    </section>
  </main>

  <!-- html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    const API = 'http://localhost:4000/api';
    const farmerId = localStorage.getItem('farmerId');

    if (!farmerId) {
      alert("Please login first.");
      location.href = 'farmer-login.html';
    } else {
      loadFarmerHistory(farmerId);
    }

    async function loadFarmerHistory(id) {
      try {
        const res = await fetch(`${API}/farmer/${id}`);
        if (!res.ok) throw new Error('Failed to load farmer info');
        const farmer = await res.json();

        document.getElementById('info').innerHTML = `
          <strong>${farmer.name}</strong><br/>
          Phone: ${farmer.phone}
        `;

        const hr = await fetch(`${API}/farmer/${id}/history`);
        if (!hr.ok) throw new Error('Failed to load history');
        const works = await hr.json();

        const tbody = document.querySelector('#historyTable tbody');
        tbody.innerHTML = '';

        let totalAmount = 0, totalPaid = 0;

        if (works.length) {
          works.forEach(w => {
            totalAmount += w.totalAmount || 0;
            totalPaid   += w.paymentGiven || 0;

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${new Date(w.date).toLocaleDateString('en-IN')}</td>
              <td>${w.workType || ''}</td>
              <td>${w.minutes || 0}</td>
              <td>${w.ratePer60 || 0}</td>
              <td>₹${(w.totalAmount || 0).toFixed(2)}</td>
              <td>₹${(w.paymentGiven || 0).toFixed(2)}</td>
              <td>${w.notes || ''}</td>
            `;
            tbody.appendChild(tr);
          });
        } else {
          tbody.innerHTML = '<tr><td colspan="7">No work history found.</td></tr>';
        }

        const balance = totalAmount - totalPaid;
        document.getElementById('totals').innerText =
          `Total Work Amount: ₹${totalAmount.toFixed(2)} | ` +
          `Total Paid: ₹${totalPaid.toFixed(2)} | Balance: ₹${balance.toFixed(2)}`;

      } catch (err) {
        console.error(err);
        alert("Something went wrong loading farmer data.");
      }
    }

    function downloadPDF() {
      const element = document.getElementById('pdfContent');
      const opt = {
        margin: 0.5,
        filename: 'work-history.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(element).save();
    }

    function logout() {
      localStorage.removeItem('farmerId');
      location.href = 'farmer-login.html';
    }
  </script>
</body>
</html>
