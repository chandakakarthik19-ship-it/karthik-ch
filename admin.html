<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
    }
    .container {
      max-width: 1000px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    h1,h3 {
      color: #333;
      margin: 10px 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #4CAF50;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    select, input[type="text"], input[type="number"] {
      padding: 6px;
      margin: 4px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    input[type="number"] {
      width: 100px;
    }
    button {
      padding: 6px 12px;
      margin: 2px 0;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    a#logout {
      float: right;
      margin-top: 10px;
      padding: 6px 12px;
      background-color: #e74c3c;
      color: white;
      text-decoration: none;
      border-radius: 4px;
    }
    a#logout:hover {
      background-color: #c0392b;
    }
    .card {
      padding: 20px;
      margin-bottom: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    @media (max-width: 768px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      th {
        position: sticky;
        top: 0;
        background-color: #4CAF50;
      }
      td {
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
      }
      td:before {
        content: attr(data-label);
        font-weight: bold;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Admin Dashboard <a href="index.html" id="logout">Logout</a></h1>

    <div class="card">
      <h3>Add Work Entry</h3>
      <label for="farmerSelect">Select Farmer</label>
      <select id="farmerSelect" aria-label="Select Farmer"></select><br/>

      <label for="workType">Work Type</label>
      <select id="workType" aria-label="Select Work Type">
        <option value="">-- Select Work Type --</option>
        <option>దుక్కు</option>
        <option>లోడింగ్</option>
        <option>రోటావేటర్</option>
        <option>దమ్ము</option>
        <option>జొన్నలు</option>
        <option>వరిసేను ఆట</option>
        <option>గత్తం</option>
      </select><br/>

      <label for="minutes">Time (hours.minutes)</label>
      <input id="minutes" type="text" placeholder="e.g., 1.2 means 1 hour 20 minutes" aria-label="Minutes worked"/>

      <label for="rate">Rate per 60</label>
      <input id="rate" type="number" placeholder="Rate per 60" aria-label="Rate per 60"/>

      <button id="addWork">Add Work</button>
    </div>

    <div class="card">
      <h3>All Work</h3>
      <label for="farmerSelectFilter">Filter by Farmer</label>
      <select id="farmerSelectFilter" aria-label="Filter by Farmer">
        <option value="">-- Select Farmer --</option>
      </select>
      <button id="viewHistory">View Farmer History</button>

      <div id="works">
        <table id="worksTable">
          <thead>
            <tr>
              <th>Farmer</th>
              <th>Date</th>
              <th>Work Type</th>
              <th>Minutes</th>
              <th>Rate per 60</th>
              <th>Total Amount</th>
              <th>Payment Given</th>
              <th>Make Payment</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const API = 'http://localhost:4000/api';
function token() { return localStorage.getItem('adminToken'); }

// Load farmers automatically
async function loadFarmers() {
  const res = await fetch(API + '/admin/farmers', { headers: { Authorization: 'Bearer ' + token() }});
  const list = await res.json();
  document.getElementById('farmerSelect').innerHTML = '<option value="">choose</option>' + list.map(f=>`<option value="${f._id}">${f.name} (${f.phone})</option>`).join('');
  document.getElementById('farmerSelectFilter').innerHTML = '<option value="">-- Select Farmer --</option>' + list.map(f=>`<option value="${f._id}">${f.name} (${f.phone})</option>`).join('');
  loadWorks();
}

// Redirect to farmer dashboard
document.getElementById('viewHistory').addEventListener('click', ()=>{
  const id = document.getElementById('farmerSelectFilter').value;
  if(!id) return alert('Select a farmer first');
  localStorage.setItem('farmerId', id);
  location.href = 'farmer.html';
});

// Add work
document.getElementById('addWork').addEventListener('click', async ()=>{
  const farmerId = document.getElementById('farmerSelect').value;
  if(!farmerId) return alert('Select a farmer');
  const workType = document.getElementById('workType').value;
  if(!workType) return alert('Select work type');
  const timeStr = document.getElementById('minutes').value.trim();
  let minutes = 0;
  if(timeStr.includes('.')) {
    const [h,m] = timeStr.split('.').map(Number);
    minutes = (h||0)*60 + (m||0);
  } else {
    minutes = Number(timeStr) || 0;
  }
  if(minutes <= 0) return alert('Enter valid time');
  const ratePer60 = Number(document.getElementById('rate').value);
  if(!ratePer60 || ratePer60 <=0) return alert('Enter valid rate');

  await fetch(API + '/admin/work', {
    method:'POST',
    headers:{ 'Content-Type':'application/json', Authorization: 'Bearer ' + token() },
    body: JSON.stringify({ farmerId, workType, minutes, ratePer60 })
  });
  alert('Work added');
  loadWorks();
});

// Load works
document.getElementById('farmerSelectFilter').addEventListener('change', loadWorks);
async function loadWorks(){
  const selectedFarmer = document.getElementById('farmerSelectFilter').value;
  const tbody = document.querySelector('#worksTable tbody');
  tbody.innerHTML = '';
  if(!selectedFarmer) return;

  const res = await fetch(API + '/admin/work?farmerId=' + selectedFarmer, { headers: { Authorization: 'Bearer ' + token() }});
  const ws = await res.json();
  let totalWork=0, totalPaid=0;

  if(ws && ws.length){
    ws.forEach(w=>{
      totalWork += w.totalAmount||0;
      totalPaid += w.paymentGiven||0;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${w.farmer?.name||'--'}</td>
        <td>${new Date(w.date).toLocaleDateString('en-IN')}</td>
        <td>${w.workType}</td>
        <td>${w.minutes}</td>
        <td>${w.ratePer60||0}</td>
        <td>₹${(w.totalAmount||0).toFixed(2)}</td>
        <td>₹${(w.paymentGiven||0).toFixed(2)}</td>
        <td>
          <input type="number" id="pay_${w._id}" placeholder="amount"/>
          <button onclick="makePayment('${w._id}','${w.farmer?._id||''}')">Pay</button>
        </td>
        <td>
          <button onclick="edit('${w._id}')">Edit</button>
          <button onclick="delWork('${w._id}')">Delete</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="5"><strong>Totals</strong></td><td><strong>₹${totalWork.toFixed(2)}</strong></td><td><strong>₹${totalPaid.toFixed(2)}</strong></td><td colspan="2"><strong>Balance: ₹${(totalWork-totalPaid).toFixed(2)}</strong></td>`;
    tbody.appendChild(tr);
  } else {
    tbody.innerHTML='<tr><td colspan="9">No records</td></tr>';
  }
}

// Make payment
window.makePayment = async function(workId, farmerId){
  const amt = Number(document.getElementById('pay_' + workId).value);
  if(!amt || amt<=0) return alert('Enter valid amount');
  const res = await fetch(API + '/admin/payment/' + farmerId, {
    method:'POST',
    headers:{'Content-Type':'application/json', Authorization:'Bearer '+token()},
    body:JSON.stringify({ amount: amt, workId })
  });
  const data = await res.json();
  if(data.success){ alert('Payment recorded'); loadWorks(); }
  else alert('Payment failed');
}

// Edit work
window.edit = async function(id){
  const workType = prompt('Work type (leave blank to keep)');
  const minutes = prompt('Minutes');
  const rate = prompt('Rate per 60');
  const paid = prompt('Payment Given (current will be replaced if entered)');
  const body={};
  if(workType) body.workType=workType;
  if(minutes) body.minutes=Number(minutes);
  if(rate) body.ratePer60=Number(rate);
  if(paid) body.paymentGiven=Number(paid);
  await fetch(API+'/admin/work/'+id,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token()},body:JSON.stringify(body)});
  alert('Updated'); loadWorks();
}

// Delete work
window.delWork = async function(id){
  if(!confirm('Delete work?')) return;
  await fetch(API+'/admin/work/'+id,{method:'DELETE',headers:{Authorization:'Bearer '+token()}});
  loadWorks();
}

// Logout
document.getElementById('logout').addEventListener('click', ()=>localStorage.removeItem('adminToken'));

// Load farmers on page load
window.addEventListener('DOMContentLoaded', loadFarmers);
</script>
</body>
</html>
